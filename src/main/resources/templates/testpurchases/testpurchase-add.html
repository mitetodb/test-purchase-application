<!DOCTYPE html>
<html lang="en" th:replace="~{layout :: layout(~{::title}, ~{::main})}"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
    <title>Create Test Purchase</title>
</head>
<body>
<main>
    <h2>Create Test Purchase</h2>

    <form th:action="@{/testpurchases/add}" th:object="${dto}" method="post">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

        <div class="mb-3">
            <label>Customer</label>
            <label for="customer"></label><select id="customer" name="customer" autocomplete="customer" th:field="*{customerId}" class="form-control">
                <option value="">--Select customer--</option>
                <option th:each="c : ${customers}" th:value="${c.id}" th:text="${c.name}">Customer</option>
            </select>
        </div>

        <div class="mb-3">
            <label>Shop</label>
            <label for="shop"></label><select id="shop" name="shop" autocomplete="shop" th:field="*{shopId}" class="form-control">
                <option value="">--Select shop--</option>
                <option th:each="s : ${shops}" th:value="${s.id}" th:text="${s.name}">Shop</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="country">Country</label>
            <select id="country" name="country" autocomplete="country" th:field="*{country}" class="form-control">
                <option value="">--Select country--</option>
                <option th:each="country : ${T(app.model.enums.Country).values()}"
                        th:value="${country}"
                        th:text="${country.getDisplayName()}">
                    Bulgaria
                </option>
            </select>
        </div>

        <div class="mb-3">
            <label for="category">Category</label>
            <select id="category" name="category" autocomplete="category" th:field="*{category}" class="form-control">
                <option value="">--Select category--</option>
                <option th:each="category : ${T(app.model.enums.TestPurchaseCategory).values()}"
                        th:value="${category}"
                        th:text="${category.getDisplayName()}">
                    M
                </option>
            </select>
        </div>

        <div class="mb-3">
            <label for="type">Type</label>
            <select id="type" th:field="*{type}" class="form-control">
                <option th:each="type : ${T(app.model.enums.TestPurchaseType).values()}"
                        th:value="${type}"
                        th:text="${type.getDisplayName()}">
                    Forwarding to client
                </option>
            </select>
        </div>

        <h5>Items</h5>
        <button type="button" class="btn btn-secondary mb-3" onclick="addItem()">+ Add Item</button>

        <div id="items-container">
            <div th:each="item, iterStat : *{items}" class="card mb-2 p-2 item-block">
                <div class="row mb-2">
                    <div class="col-md-12">
                        <input th:field="*{items[__${iterStat.index}__].productUrl}"
                               class="form-control"
                               placeholder="Product URL"
                               required />
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-5">
                        <input th:field="*{items[__${iterStat.index}__].productName}"
                               class="form-control"
                               placeholder="Product name"
                               required />
                    </div>
                    <div class="col-md-2">
                        <input type="number"
                               th:field="*{items[__${iterStat.index}__].quantity}"
                               class="form-control"
                               placeholder="Qty"
                               min="1"
                               required />
                    </div>
                    <div class="col-md-3">
                        <input type="number" step="0.01"
                               th:field="*{items[__${iterStat.index}__].unitPrice}"
                               class="form-control"
                               placeholder="Unit price"
                               min="0"
                               required />
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-danger"
                                onclick="removeItem(this)">Remove</button>
                    </div>
                </div>
            </div>
        </div>


        <button class="btn btn-success mt-3" type="submit">Create</button>
        <button class="btn btn-secondary mt-3"
                type="submit"
                formmethod="post"
                th:formaction="@{/testpurchases/add/calculate-price}">Calculate Price</button>
        <a th:href="@{/testpurchases}" class="btn btn-secondary mt-3">Cancel</a>
    </form>


    <div th:if="${price != null}" class="mt-3">
        <h5>Calculated Price</h5>
        <p>
            Product total:
            <span th:text="${price.productPrice}"></span>
        </p>
        <p>
            Service fee:
            <span th:text="${price.testPurchaseFee}"></span>
        </p>
        <p>
            Postage fee:
            <span th:text="${price.postageFee}"></span>
        </p>
    </div>

    <div th:if="${priceError != null}" class="alert alert-warning mt-3">
        <span th:text="${priceError}"></span>
    </div>
</main>
</body>
</html>