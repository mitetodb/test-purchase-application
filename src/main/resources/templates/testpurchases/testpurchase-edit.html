<!DOCTYPE html>
<html lang="en" th:replace="~{layout :: layout(~{::title}, ~{::main})}"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
    <title>Edit Test Purchase</title>
</head>
<body>
<main>
<h2>Edit Test Purchase</h2>

<form th:action="@{'/testpurchases/edit/' + ${dto.id}}" th:object="${dto}" method="post">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

    <div class="mb-3">
        <label>Customer</label>
        <select th:field="*{customerId}" class="form-control">
            <option th:each="c : ${customers}" th:value="${c.id}" th:text="${c.name}">Customer</option>
        </select>
    </div>

    <div class="mb-3">
        <label>Shop</label>
        <select th:field="*{shopId}" class="form-control">
            <option th:each="s : ${shops}" th:value="${s.id}" th:text="${s.name}">Shop</option>
        </select>
    </div>

    <div class="mb-3">
        <label>Country</label>
        <select id="country" th:field="*{country}" class="form-control">
            <option th:each="country : ${T(app.model.enums.Country).values()}" th:value="${country}" th:text="${country.getDisplayName()}">Bulgaria</option>
        </select>
    </div>

    <div class="mb-3">
        <label>Category</label>
        <select id="category" th:field="*{category}" class="form-control">
            <option th:each="category : ${T(app.model.enums.TestPurchaseCategory).values()}" th:value="${category}" th:text="${category.getDisplayName()}">M</option>
        </select>
    </div>

    <div class="mb-3">
        <label>Type</label>
        <select id="type" th:field="*{type}" class="form-control">
            <option th:each="type : ${T(app.model.enums.TestPurchaseType).values()}" th:value="${type}" th:text="${type.getDisplayName()}">Forwarding to Client</option>
        </select>
    </div>

    <h5>Items</h5>
    <button type="button" class="btn btn-secondary mb-3" onclick="addItem()">+ Add Item</button>
    <div id="items-container" th:each="item, iterStat : *{items}">
        <div class="card mb-2 p-2">
            <div class="row">
                <div class="col-md-5">
                    <input th:field="*{items[__${iterStat.index}__].productName}" class="form-control" placeholder="Product name"/>
                </div>
                <div class="col-md-2">
                    <input type="number" th:field="*{items[__${iterStat.index}__].quantity}" class="form-control" placeholder="Qty"/>
                </div>
                <div class="col-md-3">
                    <input type="number" step="0.01" th:field="*{items[__${iterStat.index}__].unitPrice}" name="productBasePrice" class="form-control" placeholder="Unit price"/>
                </div>
            </div>
        </div>
    </div>

    <button class="btn btn-warning" type="submit">Update</button>
    <a th:href="@{/testpurchases}" class="btn btn-secondary">Cancel</a>
</form>
    <script>
        // броим реалните редове в DOM-а
        let itemIndex = document.querySelectorAll('#items-container .item-row').length;
        if (itemIndex === 0) {
            itemIndex = 1;
        }

        function addItemRow(value = '') {
            const container = document.getElementById('items-container');

            const div = document.createElement('div');
            div.className = 'item-row mt-2';

            div.innerHTML = `
            <input type="text" name="items[${itemIndex}]"
                   class="form-control d-inline-block w-75"
                   value="${value}">
            <button type="button" class="btn btn-sm btn-danger ms-2" onclick="removeItemRow(this)">-</button>
        `;

            container.appendChild(div);
            itemIndex++;
        }

        function removeItemRow(btn) {
            const row = btn.parentElement;
            row.remove();
        }
    </script>
</main>
</body>
</html>
